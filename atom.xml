<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
 
 <title>Zhenyu's Blog</title>
 <link href="http://zyzhang.github.com/atom.xml" rel="self"/>
 <link href="http://zyzhang.github.com"/>
 <updated>2012-09-18T10:49:12+08:00</updated>
 <id>http://zyzhang.github.com</id>
 <author>
   <name>张振宇</name>
   <email>zhenyucheung@gmail.com</email>
 </author>

 
 <entry>
   <title>避免依赖Github Pages和Jekyll生成静态文件</title>
   <link href="http://zyzhang.github.com/blog/2012/09/10/avoid-dependency-of-github-pages-jekyll"/>
   <updated>2012-09-10T00:00:00+08:00</updated>
   <id>http://zyzhang.github.com/blog/2012/09/10/avoid-dependency-of-github-pages-jekyll</id>
   <content type="html">&lt;p&gt;之前用Github Pages + Jekyll搭建了自己的博客，有一次玩Jekyll插件之后，博客里所有使用Pygments的代码高亮都不工作了， 即使revert代码也无济于事，更奇怪的是，本地运行jekyll完全没问题，折腾很久都没有解决&amp;#8230; 最后，我只好采取了终极解决方案了。&lt;/p&gt;

&lt;p&gt;&lt;a href='https://help.github.com/articles/using-jekyll-with-pages'&gt;Github Pages的文档&lt;/a&gt;上说，当前（2012年9月）使用的是 Jekyll 0.11.0和Liquid 2.2.2，并且使用下面命令运行：&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='bash'&gt;&lt;span class='nv'&gt;$ &lt;/span&gt;jekyll --pygments --no-lsi --safe
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;很可能是版本问题造成本地行为和Github Server行为不一致，但我已经不想深究真正的原因了，因为Github Pages如何运作，出了什么问题， 对我完全不可见。&lt;/p&gt;

&lt;p&gt;最后，我采取了下面的方案&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;在repository根目录（&lt;code&gt;zyzhang.github.com&lt;/code&gt;）下创建stage文件夹，所有jekyll相关的文件都在这个文件夹下&lt;/li&gt;

&lt;li&gt;在根目录下添加&lt;code&gt;.nojekyll&lt;/code&gt;文件，github pages会禁用Jekyll&lt;/li&gt;

&lt;li&gt;每次都在stage中启动jekyll预览博客&lt;/li&gt;

&lt;li&gt;发布时，将&lt;code&gt;stage/_site&lt;/code&gt;中的所有文件copy到根目录下 （命令行中运行stage/publish）&lt;/li&gt;

&lt;li&gt;git push&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;这样，就完全解耦了对Github Pages运行环境的依赖，只要本地是work的，server上就一定是work的，另外，可以在本地随意的 使用和编写jekyll插件(Github Pages出于安全原因不会运行用户自定义的plugin)&lt;/p&gt;

&lt;p&gt;具体文件结构参见&lt;a href='https://github.com/zyzhang/zyzhang.github.com'&gt;源代码&lt;/a&gt;。&lt;/p&gt;</content>
 </entry>
 
 <entry>
   <title>Github Pages + Jekyll搭建博客之SEO</title>
   <link href="http://zyzhang.github.com/blog/2012/09/03/blog-with-github-pages-and-jekyll-seo"/>
   <updated>2012-09-03T00:00:00+08:00</updated>
   <id>http://zyzhang.github.com/blog/2012/09/03/blog-with-github-pages-and-jekyll-seo</id>
   <content type="html">&lt;p&gt;对我自己的博客而言，有些内容仅仅是自娱自乐，有没有人看不重要；而有的内容我希望能分享出去被更多的人看到，比如nHibernate Mapping By Code的一系列文章， 都是项目中实际总结出来的，那时候nHibernate刚刚增加Mapping By Code的方式，官方文档内容几乎没有，google搜索很少能找到精确的结果。所以，如果这些文章能 被更广泛的传播会帮助更多的人。&lt;/p&gt;

&lt;p&gt;在用&lt;a href='http://pages.github.com'&gt;Github Pages&lt;/a&gt; + &lt;a href='http://jekyllrb.com'&gt;Jekyll&lt;/a&gt;搭建博客的过程中， 学到了不少&lt;a href='http://en.wikipedia.org/wiki/Search_engine_optimization'&gt;SEO（Search Engine Optimization）&lt;/a&gt; 的知识，比如如何让博客被搜索引擎收录，需要注意哪些以提高排名等等。于是，便有了下面几条简单的总结。&lt;/p&gt;

&lt;h3 id='id37'&gt;让搜索引擎收录&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;如果没有任何超链接指向你的站点，在internet这个浩大的有向图中，站点就成了孤岛，不可能被搜索引擎收录。所以尽一切可能在其他网站上引用你的站点，比如友情链接， 或者在原博客上添加新博客的超链接。&lt;/p&gt;
&lt;/li&gt;

&lt;li&gt;
&lt;p&gt;&lt;a href='http://www.google.com/webmasters/'&gt;Google Webmasters - Google站长工具&lt;/a&gt;和&lt;a href='http://zhanzhang.baidu.com/welcome'&gt;百度站长工具&lt;/a&gt;都提供了提交sitemap， 提交网站URL要求搜索引擎收录，索引状态查询等功能&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id='id38'&gt;为每个页面添加描述性的信息&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;在&lt;code&gt;&amp;lt;head&amp;gt;&lt;/code&gt;标签中包含描述性强的title&lt;/li&gt;
&lt;/ul&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='html'&gt;&lt;span class='nt'&gt;&amp;lt;title&amp;gt;&lt;/span&gt;Github Pages + Jekyll搭建博客之SEO&lt;span class='nt'&gt;&amp;lt;/title&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;在&lt;code&gt;&amp;lt;meta&amp;gt;&lt;/code&gt;标签中指定准确并且可读性强的描述(description)，它会在搜索结果中显示。&lt;/li&gt;
&lt;/ul&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='html'&gt;&lt;span class='nt'&gt;&amp;lt;meta&lt;/span&gt; &lt;span class='na'&gt;content=&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;在用Github Pages + Jekyll搭建博客的过程中，学到了不少SEO（Search Engine Optimization）的知识，比如如何让博客被搜索引擎收录，如何提高排名等等。 于是，便有了下面几条简单的总结。&amp;quot;&lt;/span&gt; &lt;span class='na'&gt;name=&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;description&amp;quot;&lt;/span&gt;&lt;span class='nt'&gt;&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href='http://jekyllbootstrap.com'&gt;Jekyll-Bootstrap&lt;/a&gt;已经帮你做好这个了，只需在每个page和post的开头指定title和description就可以了:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='html'&gt;---
layout: post
title: &amp;quot;Github Pages + Jekyll搭建博客之SEO&amp;quot;
description: &amp;quot;在用Github Pages + Jekyll搭建博客的过程中，学到了不少SEO（Search Engine Optimization）的知识，比如如何让博客被搜索引擎收录，需要注意哪些以提高排名等等。于是，便有了下面几条简单的总结。&amp;quot;
category: Tech
tags: [Github Pages, Jekyll, SEO]
---
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;关于&lt;a href='http://pages.github.com'&gt;Github Pages&lt;/a&gt;，&lt;a href='http://jekyllrb.com'&gt;Jekyll&lt;/a&gt;和&lt;a href='http://jekyllbootstrap.com'&gt;Jekyll-Bootstrap&lt;/a&gt;， 请参考我的另一篇文章&lt;a href='/blog/2012/08/29/blogging-like-a-geek'&gt;像极客一样写博客&lt;/a&gt;&lt;/p&gt;

&lt;h3 id='id39'&gt;多用内部链接&lt;/h3&gt;

&lt;p&gt;内部链接指的是同一个网站的内容页面之间的互相链接，比如下面引文中的“&lt;a href='/blog/2012/08/29/blogging-like-a-geek'&gt;像极客一样写博客&lt;/a&gt;”。&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;关于&lt;a href='http://pages.github.com'&gt;Github Pages&lt;/a&gt;，&lt;a href='http://jekyllrb.com'&gt;Jekyll&lt;/a&gt;和&lt;a href='http://jekyllbootstrap.com'&gt;Jekyll-Bootstrap&lt;/a&gt;， 请参考我的另一篇文章&lt;a href='/blog/2012/08/29/blogging-like-a-geek'&gt;像极客一样写博客&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;相关性高的内部链接除了有助于提高用户体验外，还有助于提高搜索引擎的索引效率，控制站内权重分布，并提升网站的收录率。 &lt;a href='http://bbs.chinaz.com/Shuiba/thread-1683921-1-1.html'&gt;这个文章&lt;/a&gt;对内部链接总结的挺好。&lt;/p&gt;

&lt;h3 id='id40'&gt;避免死链接&lt;/h3&gt;

&lt;p&gt;&lt;a href='http://baike.baidu.com/view/1880779.htm'&gt;死链接&lt;/a&gt;即无效链接，不仅用户体验不好，还会降低网站在搜索引擎中的权重。&lt;/p&gt;

&lt;p&gt;&lt;a href='http://jekyllbootstrap.com'&gt;Jekyll-Bootstrap&lt;/a&gt;默认的permalink就是一个造成死链接的隐患：&lt;/p&gt;

&lt;p&gt;&lt;code&gt;permalink: /:categories/:year/:month/:day/:title&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;Jekyll会按照这个格式为每篇文章生成URL，例如：&lt;/p&gt;

&lt;p&gt;&lt;code&gt;zyzhang.github.com/tech/2012/01/01/helloworld&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;一旦你重新组织或修改了category，所有的内部链接都要修改，否则就成了死链接，另外，之前被搜索引擎收录的页面也全部失效了。&lt;/p&gt;

&lt;p&gt;所以，我把permalink修改成了：&lt;/p&gt;

&lt;p&gt;&lt;code&gt;permalink: /blog/:year/:month/:day/:title&lt;/code&gt;&lt;/p&gt;</content>
 </entry>
 
 <entry>
   <title>用Jekyll和Pygments配置代码高亮</title>
   <link href="http://zyzhang.github.com/blog/2012/08/31/highlight-with-Jekyll-and-Pygments"/>
   <updated>2012-08-31T00:00:00+08:00</updated>
   <id>http://zyzhang.github.com/blog/2012/08/31/highlight-with-Jekyll-and-Pygments</id>
   <content type="html">&lt;p&gt;&lt;a href='http://jekyllrb.com'&gt;Jekyll&lt;/a&gt;默认的代码段样式太丑了，而且不支持语法高亮。不过，Jekyll原生支持语法高亮工具&lt;a href='http://pygments.org'&gt;Pygments&lt;/a&gt;。Pygments支持超过100种语言， 并且支持多种输出格式，比如HTML, RTF等等。&lt;/p&gt;

&lt;h3 id='_configyml'&gt;修改_config.yml&lt;/h3&gt;

&lt;p&gt;设置&lt;code&gt;pygments: true&lt;/code&gt;&lt;/p&gt;

&lt;h3 id='pygments'&gt;本地安装Pygments&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;Pygments是基于Python的，所以机器上需要&lt;a href='http://www.python.org/download/'&gt;安装Python&lt;/a&gt;，我用的是Mac，已默认安装Python。&lt;/li&gt;

&lt;li&gt;&lt;a href='http://pypi.python.org/pypi/Pygments'&gt;下载&lt;/a&gt;最新的Pygments, 本文使用的是Pygments-1.5.tar.gz，下载完成后解压&lt;/li&gt;

&lt;li&gt;在解压后的Pygments目录中，运行命令：&lt;code&gt;sudo python setup.py install&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id='id34'&gt;选择一种喜欢的代码高亮样式&lt;/h3&gt;

&lt;p&gt;Pygments提供了多种样式，比如&amp;#8217;native&amp;#8217;, &amp;#8216;emacs&amp;#8217;, &amp;#8216;vs&amp;#8217;等等，可以在&lt;a href='http://pygments.org/demo'&gt;Pygments Demo&lt;/a&gt;中选择某种语言的例子，体验不同的样式。&lt;/p&gt;

&lt;p&gt;通过下面的命令可以查看当前支持的样式：&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='python'&gt;&lt;span class='o'&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class='kn'&gt;from&lt;/span&gt; &lt;span class='nn'&gt;pygments.styles&lt;/span&gt; &lt;span class='kn'&gt;import&lt;/span&gt; &lt;span class='n'&gt;STYLE_MAP&lt;/span&gt;
&lt;span class='o'&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;STYLE_MAP&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;keys&lt;/span&gt;&lt;span class='p'&gt;()&lt;/span&gt;
&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='s'&gt;&amp;#39;monokai&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;manni&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;rrt&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;perldoc&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;borland&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;colorful&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;default&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;murphy&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;vs&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;trac&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;tango&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;fruity&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;autumn&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;bw&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;emacs&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;vim&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;pastie&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;friendly&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;native&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;h3 id='jekyll'&gt;选择一种样式，应用在Jekyll中&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;cd /dev/projects/zyzhang.github.com/assets/themes/abel/css&lt;/code&gt;&lt;/li&gt;

&lt;li&gt;&lt;code&gt;pygmentize -S native -f html &amp;gt; pygments.css&lt;/code&gt;, “native”是样式名，“html”是formatter&lt;/li&gt;

&lt;li&gt;在layout中引用刚刚加的pygments.css&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id='id35'&gt;在文章中高亮代码&lt;/h3&gt;

&lt;p&gt;现在，可以在博客中高亮代码了：&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='html'&gt;{% highlight java %}
public class HelloWorld {
    public static void main(String args[]) {
      System.out.println(&amp;quot;Hello World!&amp;quot;);
    }
}
{% endhighlight %}
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;效果如下：&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='java'&gt;&lt;span class='kd'&gt;public&lt;/span&gt; &lt;span class='kd'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;HelloWorld&lt;/span&gt; &lt;span class='o'&gt;{&lt;/span&gt;
    &lt;span class='kd'&gt;public&lt;/span&gt; &lt;span class='kd'&gt;static&lt;/span&gt; &lt;span class='kt'&gt;void&lt;/span&gt; &lt;span class='nf'&gt;main&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='n'&gt;String&lt;/span&gt; &lt;span class='n'&gt;args&lt;/span&gt;&lt;span class='o'&gt;[])&lt;/span&gt; &lt;span class='o'&gt;{&lt;/span&gt;
      &lt;span class='n'&gt;System&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='na'&gt;out&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='na'&gt;println&lt;/span&gt;&lt;span class='o'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;Hello World!&amp;quot;&lt;/span&gt;&lt;span class='o'&gt;);&lt;/span&gt;
    &lt;span class='o'&gt;}&lt;/span&gt;
&lt;span class='o'&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;h3 id='id36'&gt;参考文章&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href='http://pygments.org/docs/styles/'&gt;Pygments Styles&lt;/a&gt;&lt;/li&gt;

&lt;li&gt;&lt;a href='https://github.com/mojombo/jekyll/wiki/Liquid-Extensions/'&gt;Liquid Extensions&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content>
 </entry>
 
 <entry>
   <title>像极客一样写博客</title>
   <link href="http://zyzhang.github.com/blog/2012/08/29/blogging-like-a-geek"/>
   <updated>2012-08-29T00:00:00+08:00</updated>
   <id>http://zyzhang.github.com/blog/2012/08/29/blogging-like-a-geek</id>
   <content type="html">&lt;p&gt;&lt;img alt='blogging' src='/assets/image/posts/blogging.jpg' /&gt;&lt;/p&gt;

&lt;p&gt;我以前用过csdn，iteye和cnblog的博客，始终不能令我满意。样式不喜欢，广告太多，富文本编辑器局限，等等等等问题， 所以每次更换博客后最终都是一个结果，太监了（好吧，我承认主要是因为懒惰&amp;#8230;）。&lt;/p&gt;

&lt;p&gt;也想过学其他同事那样，买个酷酷的域名，租个空间，再用WordPress搭个自己的博客，不过可惜，这种方式对我还是没啥驱动力&amp;#8230;&lt;/p&gt;

&lt;p&gt;日复一日，年复一年，直到有一天，GitHub Pages和Jekyll横空出世，瞬间点亮了我辈以极客自诩的屌丝程序员的双眼！&lt;/p&gt;

&lt;p&gt;最近一周的业余时间都花在了在GitHub上玩博客，并且乐此不疲，为什么这货如此吸引我呢？&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;DIY的乐趣&lt;/strong&gt;：作为一个会写HTML、Javascript、css的程序员，在自己的地盘不能把页面改成喜欢的样式简直是&amp;#8230;抓心挠肝啊。&lt;/li&gt;

&lt;li&gt;&lt;strong&gt;安全无广告&lt;/strong&gt;&lt;/li&gt;

&lt;li&gt;&lt;strong&gt;GitHub空间无极限&lt;/strong&gt;：早些时候，GitHub的Public Repository空间已经Unlimited了，给力！&lt;/li&gt;

&lt;li&gt;&lt;strong&gt;域名够酷&lt;/strong&gt;：你可能觉得&lt;code&gt;zhenyu.im&lt;/code&gt;之类的域名酷，可偶是程序员，就喜欢&lt;code&gt;zhenyu.github.com&lt;/code&gt; (可惜这个已经被人抢先了，偶只好用&lt;code&gt;zyzhang.github.com&lt;/code&gt;了)&lt;/li&gt;

&lt;li&gt;&lt;strong&gt;像写代码一样写博客&lt;/strong&gt;：版本控制的思想早已深深印在程序员的骨子里了，commit啦，push啦，pull啦，diff啦，git有的，你都有！&lt;/li&gt;

&lt;li&gt;&lt;strong&gt;真正动手实践一些以前不了解的技术&lt;/strong&gt;：参考我的另一篇文章&lt;a href='/blog/2012/09/03/blog-with-github-pages-and-jekyll-seo'&gt;Github Pages + Jekyll搭建博客之SEO&lt;/a&gt;&lt;/li&gt;

&lt;li&gt;&lt;strong&gt;只有你想不到，没有你做不到&lt;/strong&gt;：平时用Markdown写博客，简单又方便，需要特殊效果时，有什么是HTML+Javascript+css做不到的呢？&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;回到正题，如果你和我一样喜欢这种崭新的博客方式，完成下面几个任务，然后尽情享受写博客的乐趣吧。&lt;/p&gt;

&lt;h3 id='githubrepository'&gt;在Github上创建Repository&lt;/h3&gt;

&lt;p&gt;名字必须为${USERNAME}.github.com，${USERNAME}替换为你自己的用户名。&lt;/p&gt;

&lt;p&gt;现在，你可以向这个repository提交静态文件（比如index.html）, 稍等一会你就可以在浏览器地址栏输入${USERNAME}.github.com访问你的页面了。&lt;/p&gt;

&lt;h3 id='repositoryjekyll'&gt;在刚建好的repository中创建Jekyll格式的文件结构&lt;/h3&gt;

&lt;p&gt;这里，我们借助&lt;a href='http://jekyllbootstrap.com'&gt;Jekyll-Bootstrap&lt;/a&gt;，这是一个基于Jekyll的解析引擎，支持模块化的主题(modular theming)。&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='bash'&gt;&lt;span class='nv'&gt;$ &lt;/span&gt;git clone https://github.com/plusjade/jekyll-bootstrap.git USERNAME.github.com
&lt;span class='nv'&gt;$ &lt;/span&gt;&lt;span class='nb'&gt;cd &lt;/span&gt;USERNAME.github.com
&lt;span class='nv'&gt;$ &lt;/span&gt;git remote &lt;span class='nb'&gt;set&lt;/span&gt;-url origin git@github.com:USERNAME/USERNAME.github.com.git
&lt;span class='nv'&gt;$ &lt;/span&gt;git push origin master
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;&lt;img alt='jekyll-bootstrap-dir-structure' src='/assets/image/posts/jekyll-bootstrap-dir-structure.png' /&gt;&lt;/p&gt;

&lt;p&gt;上面代码创建了如左图的Jekyll-Bootstrap标准目录结构，各个文件夹的用途在&lt;a href='http://jekyllbootstrap.com/lessons/jekyll-introduction.html'&gt;Jekyll Introduction&lt;/a&gt;中介绍的很清楚了，这里不再多说。&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;需要注意的是：&lt;/strong&gt;&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;_includes下的themes文件夹，这是定义主题的地方。&lt;/li&gt;

&lt;li&gt;Jekyll支持&lt;a href='http://en.wikipedia.org/wiki/Markdown'&gt;Markdown&lt;/a&gt;等轻量级标记语言，所以有很多文件以.md为后缀名。&lt;/li&gt;

&lt;li&gt;文章都放在_posts文件夹下，post的文件名必须遵循&lt;code&gt;YEAR-MONTH-DATE-title.后缀名&lt;/code&gt;的格式，例如：2012-08-29-像极客一样写博客.md&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;这时候访问你的博客页面，会看到默认的twitter主题样式，更多主题可以访问 &lt;a href='http://themes.jekyllbootstrap.com'&gt;http://themes.jekyllbootstrap.com&lt;/a&gt;。&lt;/p&gt;

&lt;h3 id='jekyll'&gt;安装Jekyll&lt;/h3&gt;

&lt;p&gt;安装Jekyll后，可以很方便的在发布文章之前进行本地预览。下面是安装步骤：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Jekyll是基于Ruby的，所以，要先&lt;a href='http://www.ruby-lang.org/en/downloads'&gt;安装Ruby&lt;/a&gt;。&lt;/li&gt;

&lt;li&gt;通过ruby gem安装：&lt;code&gt; gem install jekyll&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;安装完毕后，在${USERNAME}.github.com目录下运行&lt;code&gt;jekyll --server&lt;/code&gt;启动server，然后就可以在本地访问http://localhost:4000预览博客了。&lt;/p&gt;

&lt;h3 id='id30'&gt;自定义主题&lt;/h3&gt;

&lt;p&gt;Jekyll-Bootstrap的主题管理很简单，有两种方式，一种是安装官方提供的主题，一种是自定义主题，详细内容参考&lt;a href='http://jekyllbootstrap.com/usage/jekyll-theming.html'&gt;Using Themes&lt;/a&gt;&lt;/p&gt;

&lt;h3 id='id31'&gt;发布博客&lt;/h3&gt;

&lt;p&gt;发布博客和管理代码库一样，可以利用到git的强大功能，只要push上去了，本地更改就发布了。&lt;/p&gt;

&lt;h3 id='id32'&gt;例子&lt;/h3&gt;

&lt;p&gt;本博客就是依照上述步骤搭建起来的，你可以访问完整&lt;a href='https://github.com/zyzhang/zyzhang.github.com'&gt;源代码&lt;/a&gt;, 另外，由于Github Pages出于安全原因不支持用户自定义Jekyll插件，并且有时候Pygments代码高亮也有些问题，所以我改变了发布策略，只发布静态文件，详情见 &lt;a href='http://zyzhang.github.com/blog/2012/09/10/avoid-dependency-of-github-pages-jekyll'&gt;避免依赖Github Pages和Jekyll生成静态文件&lt;/a&gt;。 如果你不关心上述问题，仍然可以按照上面的步骤搭建标准的Github博客。&lt;/p&gt;

&lt;h3 id='id33'&gt;参考文章&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href='http://jekyllbootstrap.com/lessons/jekyll-introduction.html'&gt;Jekyll Introduction&lt;/a&gt;&lt;/li&gt;

&lt;li&gt;&lt;a href='http://jekyllbootstrap.com/usage/jekyll-quick-start.html'&gt;Jekyll Quick Start&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content>
 </entry>
 
 <entry>
   <title>nHibernate Mapping By Code - One to One</title>
   <link href="http://zyzhang.github.com/blog/2012/07/01/nHibernateMappingByCode-OneToOne"/>
   <updated>2012-07-01T00:00:00+08:00</updated>
   <id>http://zyzhang.github.com/blog/2012/07/01/nHibernateMappingByCode-OneToOne</id>
   <content type="html">&lt;p&gt;nHibernate提供两种one to one关联：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;primary key associations&lt;/li&gt;

&lt;li&gt;unique foreign key associations&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;下面分别用mapping by code的方式配置这两种关联。 关于如何配置nhibernate使用mapping by code，参考&lt;a href='/blog/2012/07/01/nHibernateMappingByCode-Introduction'&gt;nHibernate Mapping By Code - Introduction&lt;/a&gt;&lt;/p&gt;

&lt;h3 id='1_primary_key_associations'&gt;1. primary key associations&lt;/h3&gt;

&lt;h4 id='id26'&gt;实体类&lt;/h4&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='csharp'&gt;&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;Person&lt;/span&gt;
&lt;span class='p'&gt;{&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='kt'&gt;int&lt;/span&gt; &lt;span class='n'&gt;Id&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='kt'&gt;string&lt;/span&gt; &lt;span class='n'&gt;Name&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='n'&gt;PersonInfo&lt;/span&gt; &lt;span class='n'&gt;PersonInfo&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt; 
&lt;span class='p'&gt;}&lt;/span&gt;

&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;PersonInfo&lt;/span&gt;
&lt;span class='p'&gt;{&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='kt'&gt;int&lt;/span&gt; &lt;span class='n'&gt;Id&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='kt'&gt;string&lt;/span&gt; &lt;span class='n'&gt;PhoneNumber&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='kt'&gt;string&lt;/span&gt; &lt;span class='n'&gt;Remarks&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt; 
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='n'&gt;Person&lt;/span&gt; &lt;span class='n'&gt;Person&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt; 
&lt;span class='p'&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;h4 id='ms_sql_server_2012'&gt;数据库表（基于MS SQL Server 2012）&lt;/h4&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='sql'&gt;&lt;span class='k'&gt;CREATE&lt;/span&gt; &lt;span class='k'&gt;TABLE&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;dbo&lt;/span&gt;&lt;span class='p'&gt;].[&lt;/span&gt;&lt;span class='n'&gt;Person&lt;/span&gt;&lt;span class='p'&gt;](&lt;/span&gt;
    &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nb'&gt;int&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;IDENTITY&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='mi'&gt;1&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;&lt;span class='mi'&gt;1&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;NOT&lt;/span&gt; &lt;span class='k'&gt;NULL&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;
    &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;Name&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nb'&gt;varchar&lt;/span&gt;&lt;span class='p'&gt;](&lt;/span&gt;&lt;span class='mi'&gt;50&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;NOT&lt;/span&gt; &lt;span class='k'&gt;NULL&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;    
 &lt;span class='k'&gt;CONSTRAINT&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;PK_Person&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;PRIMARY&lt;/span&gt; &lt;span class='k'&gt;KEY&lt;/span&gt; &lt;span class='n'&gt;CLUSTERED&lt;/span&gt; &lt;span class='p'&gt;([&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;ASC&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;

&lt;span class='k'&gt;CREATE&lt;/span&gt; &lt;span class='k'&gt;TABLE&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;dbo&lt;/span&gt;&lt;span class='p'&gt;].[&lt;/span&gt;&lt;span class='n'&gt;PersonInfo&lt;/span&gt;&lt;span class='p'&gt;](&lt;/span&gt;
    &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nb'&gt;int&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;NOT&lt;/span&gt; &lt;span class='k'&gt;NULL&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;
    &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;PhoneNumber&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nb'&gt;varchar&lt;/span&gt;&lt;span class='p'&gt;](&lt;/span&gt;&lt;span class='mi'&gt;50&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;NOT&lt;/span&gt; &lt;span class='k'&gt;NULL&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;
    &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;Remarks&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nb'&gt;varchar&lt;/span&gt;&lt;span class='p'&gt;](&lt;/span&gt;&lt;span class='mi'&gt;100&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;NOT&lt;/span&gt; &lt;span class='k'&gt;NULL&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;
 &lt;span class='k'&gt;CONSTRAINT&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;PK_PersonInfo&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;PRIMARY&lt;/span&gt; &lt;span class='k'&gt;KEY&lt;/span&gt; &lt;span class='n'&gt;CLUSTERED&lt;/span&gt; &lt;span class='p'&gt;([&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;ASC&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;h4 id='id27'&gt;映射类&lt;/h4&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='csharp'&gt;&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;PersonMapping&lt;/span&gt; &lt;span class='p'&gt;:&lt;/span&gt; &lt;span class='n'&gt;ClassMapping&lt;/span&gt;&lt;span class='p'&gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;Person&lt;/span&gt;&lt;span class='p'&gt;&amp;gt;;&lt;/span&gt;
&lt;span class='p'&gt;{&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='nf'&gt;PersonMapping&lt;/span&gt;&lt;span class='p'&gt;()&lt;/span&gt;
    &lt;span class='p'&gt;{&lt;/span&gt;
        &lt;span class='n'&gt;Table&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;Person&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
        &lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;person&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;person&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Generator&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;Generators&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Identity&lt;/span&gt;&lt;span class='p'&gt;));&lt;/span&gt;
        &lt;span class='n'&gt;Property&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;person&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;person&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Name&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
        &lt;span class='n'&gt;OneToOne&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;person&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;person&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;PersonInfo&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Cascade&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;Cascade&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;All&lt;/span&gt;&lt;span class='p'&gt;));&lt;/span&gt;
    &lt;span class='p'&gt;}&lt;/span&gt;
&lt;span class='p'&gt;}&lt;/span&gt;

&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;PersonInfoMapping&lt;/span&gt; &lt;span class='p'&gt;:&lt;/span&gt; &lt;span class='n'&gt;ClassMapping&lt;/span&gt;&lt;span class='p'&gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;PersonInfo&lt;/span&gt;&lt;span class='p'&gt;&amp;gt;&lt;/span&gt;
&lt;span class='p'&gt;{&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='nf'&gt;PersonInfoMapping&lt;/span&gt;&lt;span class='p'&gt;()&lt;/span&gt;
    &lt;span class='p'&gt;{&lt;/span&gt;
        &lt;span class='n'&gt;Table&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;PersonInfo&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
        &lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;personInfo&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;personInfo&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Generator&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;Generators&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Foreign&lt;/span&gt;&lt;span class='p'&gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;PersonInfo&lt;/span&gt;&lt;span class='p'&gt;&amp;gt;(&lt;/span&gt;&lt;span class='n'&gt;personInfo&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;personInfo&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Person&lt;/span&gt;&lt;span class='p'&gt;)));&lt;/span&gt;
        &lt;span class='n'&gt;Property&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;personInfo&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;personInfo&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;PhoneNumber&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
        &lt;span class='n'&gt;Property&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;personInfo&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;personInfo&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Remarks&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
        &lt;span class='n'&gt;OneToOne&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;personInfo&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;personInfo&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Person&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt; &lt;span class='p'&gt;=&amp;amp;&lt;/span&gt;&lt;span class='n'&gt;gt&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Constrained&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='k'&gt;true&lt;/span&gt;&lt;span class='p'&gt;));&lt;/span&gt;
    &lt;span class='p'&gt;}&lt;/span&gt;
&lt;span class='p'&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;h3 id='2_unique_foreign_key_associations'&gt;2. unique foreign key associations&lt;/h3&gt;

&lt;h4 id='id28'&gt;实体类&lt;/h4&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='csharp'&gt;&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;Customer&lt;/span&gt;
&lt;span class='p'&gt;{&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='kt'&gt;int&lt;/span&gt; &lt;span class='n'&gt;Id&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='kt'&gt;string&lt;/span&gt; &lt;span class='n'&gt;Name&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='n'&gt;CustomerInfo&lt;/span&gt; &lt;span class='n'&gt;CustomerInfo&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt; 
&lt;span class='p'&gt;}&lt;/span&gt;

&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;CustomerInfo&lt;/span&gt;
&lt;span class='p'&gt;{&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='kt'&gt;int&lt;/span&gt; &lt;span class='n'&gt;Id&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='kt'&gt;string&lt;/span&gt; &lt;span class='n'&gt;PhoneNumber&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='kt'&gt;string&lt;/span&gt; &lt;span class='n'&gt;Remarks&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='n'&gt;Customer&lt;/span&gt; &lt;span class='n'&gt;Customer&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt; 
&lt;span class='p'&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt; &lt;/p&gt;

&lt;h4 id='ms_sql_server_2012'&gt;数据库表（基于MS SQL Server 2012）&lt;/h4&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='sql'&gt;&lt;span class='k'&gt;CREATE&lt;/span&gt; &lt;span class='k'&gt;TABLE&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;dbo&lt;/span&gt;&lt;span class='p'&gt;].[&lt;/span&gt;&lt;span class='n'&gt;CustomerInfo&lt;/span&gt;&lt;span class='p'&gt;](&lt;/span&gt;
    &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nb'&gt;int&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;IDENTITY&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='mi'&gt;1&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;&lt;span class='mi'&gt;1&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;NOT&lt;/span&gt; &lt;span class='k'&gt;NULL&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;
    &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;PhoneNumber&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nb'&gt;varchar&lt;/span&gt;&lt;span class='p'&gt;](&lt;/span&gt;&lt;span class='mi'&gt;50&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;NOT&lt;/span&gt; &lt;span class='k'&gt;NULL&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;
    &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;Remarks&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nb'&gt;varchar&lt;/span&gt;&lt;span class='p'&gt;](&lt;/span&gt;&lt;span class='mi'&gt;50&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;NOT&lt;/span&gt; &lt;span class='k'&gt;NULL&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;
 &lt;span class='k'&gt;CONSTRAINT&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;PK_CustomerInfo&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;PRIMARY&lt;/span&gt; &lt;span class='k'&gt;KEY&lt;/span&gt; &lt;span class='n'&gt;CLUSTERED&lt;/span&gt; &lt;span class='p'&gt;([&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;ASC&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;

&lt;span class='k'&gt;CREATE&lt;/span&gt; &lt;span class='k'&gt;TABLE&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;dbo&lt;/span&gt;&lt;span class='p'&gt;].[&lt;/span&gt;&lt;span class='n'&gt;Customer&lt;/span&gt;&lt;span class='p'&gt;](&lt;/span&gt;
    &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nb'&gt;int&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;IDENTITY&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='mi'&gt;1&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;&lt;span class='mi'&gt;1&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;NOT&lt;/span&gt; &lt;span class='k'&gt;NULL&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;
    &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;Name&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nb'&gt;varchar&lt;/span&gt;&lt;span class='p'&gt;](&lt;/span&gt;&lt;span class='mi'&gt;50&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;NOT&lt;/span&gt; &lt;span class='k'&gt;NULL&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;
    &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;CustomerInfoId&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nb'&gt;int&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;NOT&lt;/span&gt; &lt;span class='k'&gt;NULL&lt;/span&gt; &lt;span class='k'&gt;Unique&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;    
 &lt;span class='k'&gt;CONSTRAINT&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;PK_Customer&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;PRIMARY&lt;/span&gt; &lt;span class='k'&gt;KEY&lt;/span&gt; &lt;span class='n'&gt;CLUSTERED&lt;/span&gt; &lt;span class='p'&gt;([&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;ASC&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;

 &lt;span class='k'&gt;ALTER&lt;/span&gt; &lt;span class='k'&gt;TABLE&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;dbo&lt;/span&gt;&lt;span class='p'&gt;].[&lt;/span&gt;&lt;span class='n'&gt;Customer&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;ADD&lt;/span&gt; &lt;span class='k'&gt;CONSTRAINT&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;FK_Customer_CustomerInfoId&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;FOREIGN&lt;/span&gt; &lt;span class='k'&gt;KEY&lt;/span&gt;&lt;span class='p'&gt;([&lt;/span&gt;&lt;span class='n'&gt;CustomerInfoId&lt;/span&gt;&lt;span class='p'&gt;])&lt;/span&gt;
&lt;span class='k'&gt;REFERENCES&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;dbo&lt;/span&gt;&lt;span class='p'&gt;].[&lt;/span&gt;&lt;span class='n'&gt;CustomerInfo&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;([&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;])&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;h4 id='id29'&gt;映射类&lt;/h4&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='csharp'&gt;&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='nf'&gt;CustomerMapping&lt;/span&gt;&lt;span class='p'&gt;()&lt;/span&gt;
&lt;span class='p'&gt;{&lt;/span&gt;
    &lt;span class='n'&gt;Table&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;Customer&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
    &lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;customer&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;customer&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Generator&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;Generators&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Identity&lt;/span&gt;&lt;span class='p'&gt;));&lt;/span&gt;
    &lt;span class='n'&gt;Property&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;customer&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;customer&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Name&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
    &lt;span class='n'&gt;ManyToOne&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;customer&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;customer&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;CustomerInfo&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt;
        &lt;span class='p'&gt;{&lt;/span&gt;
            &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Cascade&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;Cascade&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;All&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
            &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Column&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;CustomerInfoId&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
        &lt;span class='p'&gt;});&lt;/span&gt;
&lt;span class='p'&gt;}&lt;/span&gt;

&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='nf'&gt;CustomerInfoMapping&lt;/span&gt;&lt;span class='p'&gt;()&lt;/span&gt;
&lt;span class='p'&gt;{&lt;/span&gt;
    &lt;span class='n'&gt;Table&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;CustomerInfo&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
    &lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;customerInfo&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;customerInfo&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Generator&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;Generators&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Identity&lt;/span&gt;&lt;span class='p'&gt;));&lt;/span&gt;
    &lt;span class='n'&gt;Property&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;customerInfo&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;customerInfo&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;PhoneNumber&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
    &lt;span class='n'&gt;Property&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;customerInfo&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;customerInfo&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Remarks&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
    &lt;span class='n'&gt;OneToOne&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;customerInfo&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;customerInfo&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Customer&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;PropertyReference&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='k'&gt;typeof&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;Customer&lt;/span&gt;&lt;span class='p'&gt;).&lt;/span&gt;&lt;span class='n'&gt;GetProperty&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;CustomerInfo&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;)));&lt;/span&gt;
&lt;span class='p'&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;</content>
 </entry>
 
 <entry>
   <title>nHibernate Mapping By Code - One to Many & Many to One</title>
   <link href="http://zyzhang.github.com/blog/2012/07/01/nHibernateMappingByCode-OneToManyandManyToOne"/>
   <updated>2012-07-01T00:00:00+08:00</updated>
   <id>http://zyzhang.github.com/blog/2012/07/01/nHibernateMappingByCode-OneToManyandManyToOne</id>
   <content type="html">&lt;p&gt;Mapping by code是nHibernate3.2新增的功能，网络上及官方doc相关的介绍都很少。下面是如何使用mapping by code的方式配置一对多和多对一关联的例子。&lt;/p&gt;

&lt;p&gt;关于如何配置nhibernate使用mapping by code，参考&lt;a href='/blog/2012/07/01/nHibernateMappingByCode-Introduction'&gt;nHibernate Mapping By Code - Introduction&lt;/a&gt;&lt;/p&gt;

&lt;h3 id='id24'&gt;实体类&lt;/h3&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='csharp'&gt;&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;Employee&lt;/span&gt;
&lt;span class='p'&gt;{&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='kt'&gt;int&lt;/span&gt; &lt;span class='n'&gt;Id&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='kt'&gt;string&lt;/span&gt; &lt;span class='n'&gt;Name&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='kt'&gt;string&lt;/span&gt; &lt;span class='n'&gt;IdentityNumber&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='n'&gt;Department&lt;/span&gt; &lt;span class='n'&gt;Department&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
&lt;span class='p'&gt;}&lt;/span&gt;

&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;Department&lt;/span&gt;
&lt;span class='p'&gt;{&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='kt'&gt;int&lt;/span&gt; &lt;span class='n'&gt;Id&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='kt'&gt;string&lt;/span&gt; &lt;span class='n'&gt;Name&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='n'&gt;IList&lt;/span&gt;&lt;span class='p'&gt;&amp;amp;&lt;/span&gt;&lt;span class='n'&gt;lt&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt;&lt;span class='n'&gt;Employee&lt;/span&gt;&lt;span class='p'&gt;&amp;amp;&lt;/span&gt;&lt;span class='n'&gt;gt&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='n'&gt;Employees&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
&lt;span class='p'&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt; &lt;/p&gt;

&lt;h3 id='ms_sql_server_2012'&gt;数据库表（基于MS SQL Server 2012）&lt;/h3&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='sql'&gt;&lt;span class='k'&gt;CREATE&lt;/span&gt; &lt;span class='k'&gt;TABLE&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;dbo&lt;/span&gt;&lt;span class='p'&gt;].[&lt;/span&gt;&lt;span class='n'&gt;Department&lt;/span&gt;&lt;span class='p'&gt;](&lt;/span&gt;
    &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nb'&gt;int&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;IDENTITY&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='mi'&gt;1&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;&lt;span class='mi'&gt;1&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;NOT&lt;/span&gt; &lt;span class='k'&gt;NULL&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;
    &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;Name&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nb'&gt;varchar&lt;/span&gt;&lt;span class='p'&gt;](&lt;/span&gt;&lt;span class='mi'&gt;50&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;NOT&lt;/span&gt; &lt;span class='k'&gt;NULL&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;
 &lt;span class='k'&gt;CONSTRAINT&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;PK_Department&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;PRIMARY&lt;/span&gt; &lt;span class='k'&gt;KEY&lt;/span&gt; &lt;span class='n'&gt;CLUSTERED&lt;/span&gt; &lt;span class='p'&gt;([&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;ASC&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;

&lt;span class='k'&gt;CREATE&lt;/span&gt; &lt;span class='k'&gt;TABLE&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;dbo&lt;/span&gt;&lt;span class='p'&gt;].[&lt;/span&gt;&lt;span class='n'&gt;Employee&lt;/span&gt;&lt;span class='p'&gt;](&lt;/span&gt;
    &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nb'&gt;int&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;IDENTITY&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='mi'&gt;1&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;&lt;span class='mi'&gt;1&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;NOT&lt;/span&gt; &lt;span class='k'&gt;NULL&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;
    &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;Name&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nb'&gt;varchar&lt;/span&gt;&lt;span class='p'&gt;](&lt;/span&gt;&lt;span class='mi'&gt;50&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;NOT&lt;/span&gt; &lt;span class='k'&gt;NULL&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;
    &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;IdentityNumber&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nb'&gt;varchar&lt;/span&gt;&lt;span class='p'&gt;](&lt;/span&gt;&lt;span class='mi'&gt;50&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;NOT&lt;/span&gt; &lt;span class='k'&gt;NULL&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;
    &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;DepartmentId&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nb'&gt;int&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;NOT&lt;/span&gt; &lt;span class='k'&gt;NULL&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;
 &lt;span class='k'&gt;CONSTRAINT&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;PK_Employee&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;PRIMARY&lt;/span&gt; &lt;span class='k'&gt;KEY&lt;/span&gt; &lt;span class='n'&gt;CLUSTERED&lt;/span&gt; &lt;span class='p'&gt;([&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;ASC&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;

&lt;span class='k'&gt;ALTER&lt;/span&gt; &lt;span class='k'&gt;TABLE&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;dbo&lt;/span&gt;&lt;span class='p'&gt;].[&lt;/span&gt;&lt;span class='n'&gt;Employee&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;ADD&lt;/span&gt; &lt;span class='k'&gt;CONSTRAINT&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;FK_Employee_DepartmentId&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;FOREIGN&lt;/span&gt; &lt;span class='k'&gt;KEY&lt;/span&gt;&lt;span class='p'&gt;([&lt;/span&gt;&lt;span class='n'&gt;DepartmentId&lt;/span&gt;&lt;span class='p'&gt;])&lt;/span&gt;
&lt;span class='k'&gt;REFERENCES&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;dbo&lt;/span&gt;&lt;span class='p'&gt;].[&lt;/span&gt;&lt;span class='n'&gt;Department&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;([&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;])&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;h3 id='id25'&gt;映射类&lt;/h3&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='csharp'&gt;&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;DepartmentMapping&lt;/span&gt; &lt;span class='p'&gt;:&lt;/span&gt; &lt;span class='n'&gt;ClassMapping&lt;/span&gt;&lt;span class='p'&gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;Department&lt;/span&gt;&lt;span class='p'&gt;&amp;gt;&lt;/span&gt;
&lt;span class='p'&gt;{&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='nf'&gt;DepartmentMapping&lt;/span&gt;&lt;span class='p'&gt;()&lt;/span&gt;
    &lt;span class='p'&gt;{&lt;/span&gt;
        &lt;span class='n'&gt;Table&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;Department&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
        &lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;department&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;department&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Generator&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;Generators&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Identity&lt;/span&gt;&lt;span class='p'&gt;));&lt;/span&gt;
        &lt;span class='n'&gt;Property&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;department&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;department&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Name&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
        &lt;span class='n'&gt;Bag&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;department&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;department&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Employees&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Key&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;k&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;k&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Column&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;DepartmentId&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;)),&lt;/span&gt; &lt;span class='n'&gt;rel&lt;/span&gt;&lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;rel&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;OneToMany&lt;/span&gt;&lt;span class='p'&gt;());&lt;/span&gt;
    &lt;span class='p'&gt;}&lt;/span&gt;
&lt;span class='p'&gt;}&lt;/span&gt;

&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;EmployeeMapping&lt;/span&gt; &lt;span class='p'&gt;:&lt;/span&gt; &lt;span class='n'&gt;ClassMapping&lt;/span&gt;&lt;span class='p'&gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;Employee&lt;/span&gt;&lt;span class='p'&gt;&amp;gt;&lt;/span&gt;
&lt;span class='p'&gt;{&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='nf'&gt;EmployeeMapping&lt;/span&gt;&lt;span class='p'&gt;()&lt;/span&gt;
    &lt;span class='p'&gt;{&lt;/span&gt;
        &lt;span class='n'&gt;Table&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;Employee&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
        &lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;employee&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;employee&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Generator&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;Generators&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Identity&lt;/span&gt;&lt;span class='p'&gt;));&lt;/span&gt;
        &lt;span class='n'&gt;Property&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;employee&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;employee&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Name&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
        &lt;span class='n'&gt;Property&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;employee&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;employee&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;IdentityNumber&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
        &lt;span class='n'&gt;ManyToOne&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;employee&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;employee&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Department&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Column&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;DepartmentId&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;));&lt;/span&gt;
    &lt;span class='p'&gt;}&lt;/span&gt;
&lt;span class='p'&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;</content>
 </entry>
 
 <entry>
   <title>nHibernate Mapping By Code - Many to Many</title>
   <link href="http://zyzhang.github.com/blog/2012/07/01/nHibernateMappingByCode-ManyToMany"/>
   <updated>2012-07-01T00:00:00+08:00</updated>
   <id>http://zyzhang.github.com/blog/2012/07/01/nHibernateMappingByCode-ManyToMany</id>
   <content type="html">&lt;p&gt;Mapping by code是nHibernate3.2新增的功能，网络上及官方doc相关的介绍都很少。下面是如何使用mapping by code的方式 配置多对多关联的例子。&lt;/p&gt;

&lt;p&gt;关于如何配置nhibernate使用mapping by code，参考&lt;a href='/blog/2012/07/01/nHibernateMappingByCode-Introduction'&gt;nHibernate Mapping By Code - Introduction&lt;/a&gt;&lt;/p&gt;

&lt;h3 id='id22'&gt;实体类&lt;/h3&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='csharp'&gt;&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;Student&lt;/span&gt;
&lt;span class='p'&gt;{&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='kt'&gt;int&lt;/span&gt; &lt;span class='n'&gt;Id&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='kt'&gt;string&lt;/span&gt; &lt;span class='n'&gt;Name&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='n'&gt;IList&lt;/span&gt;&lt;span class='p'&gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;Course&lt;/span&gt;&lt;span class='p'&gt;&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;Courses&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
&lt;span class='p'&gt;}&lt;/span&gt;

&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;Course&lt;/span&gt;
&lt;span class='p'&gt;{&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='kt'&gt;int&lt;/span&gt; &lt;span class='n'&gt;Id&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='kt'&gt;string&lt;/span&gt; &lt;span class='n'&gt;Name&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt; 
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='n'&gt;IList&lt;/span&gt;&lt;span class='p'&gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;Student&lt;/span&gt;&lt;span class='p'&gt;&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;Students&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt; 
&lt;span class='p'&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;h3 id='ms_sql_server_2012'&gt;数据库表（基于MS SQL Server 2012）&lt;/h3&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='sql'&gt;&lt;span class='k'&gt;CREATE&lt;/span&gt; &lt;span class='k'&gt;TABLE&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;dbo&lt;/span&gt;&lt;span class='p'&gt;].[&lt;/span&gt;&lt;span class='n'&gt;Student&lt;/span&gt;&lt;span class='p'&gt;](&lt;/span&gt;
    &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nb'&gt;int&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;IDENTITY&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='mi'&gt;1&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;&lt;span class='mi'&gt;1&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;NOT&lt;/span&gt; &lt;span class='k'&gt;NULL&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;
    &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;Name&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nb'&gt;varchar&lt;/span&gt;&lt;span class='p'&gt;](&lt;/span&gt;&lt;span class='mi'&gt;50&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;NOT&lt;/span&gt; &lt;span class='k'&gt;NULL&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;    
 &lt;span class='k'&gt;CONSTRAINT&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;PK_Student&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;PRIMARY&lt;/span&gt; &lt;span class='k'&gt;KEY&lt;/span&gt; &lt;span class='n'&gt;CLUSTERED&lt;/span&gt; &lt;span class='p'&gt;([&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;ASC&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;

&lt;span class='k'&gt;CREATE&lt;/span&gt; &lt;span class='k'&gt;TABLE&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;dbo&lt;/span&gt;&lt;span class='p'&gt;].[&lt;/span&gt;&lt;span class='n'&gt;Course&lt;/span&gt;&lt;span class='p'&gt;](&lt;/span&gt;
    &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nb'&gt;int&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;IDENTITY&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='mi'&gt;1&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;&lt;span class='mi'&gt;1&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;NOT&lt;/span&gt; &lt;span class='k'&gt;NULL&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;
    &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;Name&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nb'&gt;varchar&lt;/span&gt;&lt;span class='p'&gt;](&lt;/span&gt;&lt;span class='mi'&gt;50&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;NOT&lt;/span&gt; &lt;span class='k'&gt;NULL&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;    
 &lt;span class='k'&gt;CONSTRAINT&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;PK_Course&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;PRIMARY&lt;/span&gt; &lt;span class='k'&gt;KEY&lt;/span&gt; &lt;span class='n'&gt;CLUSTERED&lt;/span&gt; &lt;span class='p'&gt;([&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;ASC&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;

&lt;span class='k'&gt;CREATE&lt;/span&gt; &lt;span class='k'&gt;TABLE&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;dbo&lt;/span&gt;&lt;span class='p'&gt;].[&lt;/span&gt;&lt;span class='n'&gt;Student_Course&lt;/span&gt;&lt;span class='p'&gt;](&lt;/span&gt;
    &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;StudentId&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nb'&gt;int&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;NOT&lt;/span&gt; &lt;span class='k'&gt;NULL&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;
    &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;CourseId&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nb'&gt;int&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;NOT&lt;/span&gt; &lt;span class='k'&gt;NULL&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;    
 &lt;span class='k'&gt;CONSTRAINT&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;PK_Student_Course&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;PRIMARY&lt;/span&gt; &lt;span class='k'&gt;KEY&lt;/span&gt; &lt;span class='n'&gt;CLUSTERED&lt;/span&gt; &lt;span class='p'&gt;([&lt;/span&gt;&lt;span class='n'&gt;StudentId&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;ASC&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;CourseId&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;ASC&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;

&lt;span class='k'&gt;ALTER&lt;/span&gt; &lt;span class='k'&gt;TABLE&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;dbo&lt;/span&gt;&lt;span class='p'&gt;].[&lt;/span&gt;&lt;span class='n'&gt;Student_Course&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;ADD&lt;/span&gt; &lt;span class='k'&gt;CONSTRAINT&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;FK_Student_Course_StudentId&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;FOREIGN&lt;/span&gt; &lt;span class='k'&gt;KEY&lt;/span&gt;&lt;span class='p'&gt;([&lt;/span&gt;&lt;span class='n'&gt;StudentId&lt;/span&gt;&lt;span class='p'&gt;])&lt;/span&gt;
&lt;span class='k'&gt;REFERENCES&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;dbo&lt;/span&gt;&lt;span class='p'&gt;].[&lt;/span&gt;&lt;span class='n'&gt;Student&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;([&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;])&lt;/span&gt;

&lt;span class='k'&gt;ALTER&lt;/span&gt; &lt;span class='k'&gt;TABLE&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;dbo&lt;/span&gt;&lt;span class='p'&gt;].[&lt;/span&gt;&lt;span class='n'&gt;Student_Course&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;ADD&lt;/span&gt; &lt;span class='k'&gt;CONSTRAINT&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;FK_Student_Course_CourseId&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='k'&gt;FOREIGN&lt;/span&gt; &lt;span class='k'&gt;KEY&lt;/span&gt;&lt;span class='p'&gt;([&lt;/span&gt;&lt;span class='n'&gt;CourseId&lt;/span&gt;&lt;span class='p'&gt;])&lt;/span&gt;
&lt;span class='k'&gt;REFERENCES&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;dbo&lt;/span&gt;&lt;span class='p'&gt;].[&lt;/span&gt;&lt;span class='n'&gt;Course&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;([&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;])&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt; &lt;/p&gt;

&lt;h3 id='id23'&gt;映射类&lt;/h3&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='csharp'&gt;&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;CourseMapping&lt;/span&gt; &lt;span class='p'&gt;:&lt;/span&gt; &lt;span class='n'&gt;ClassMapping&lt;/span&gt;&lt;span class='p'&gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;Course&lt;/span&gt;&lt;span class='p'&gt;&amp;gt;&lt;/span&gt;
&lt;span class='p'&gt;{&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='nf'&gt;CourseMapping&lt;/span&gt;&lt;span class='p'&gt;()&lt;/span&gt;
    &lt;span class='p'&gt;{&lt;/span&gt;
        &lt;span class='n'&gt;Table&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;Course&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
        &lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;course&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;course&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Generator&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;Generators&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Identity&lt;/span&gt;&lt;span class='p'&gt;));&lt;/span&gt;
        &lt;span class='n'&gt;Property&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;course&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;course&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Name&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
        &lt;span class='n'&gt;Bag&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;course&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;course&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Students&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt;
        &lt;span class='p'&gt;{&lt;/span&gt;
            &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Table&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;Student_Course&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
            &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Key&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;keyMapper&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;keyMapper&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Column&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;CourseId&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;));&lt;/span&gt;
        &lt;span class='p'&gt;},&lt;/span&gt; &lt;span class='n'&gt;rel&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;rel&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;ManyToMany&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;m&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;m&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Column&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;StudentId&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;)));&lt;/span&gt;
    &lt;span class='p'&gt;}&lt;/span&gt;
&lt;span class='p'&gt;}&lt;/span&gt;

&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;StudentMapping&lt;/span&gt; &lt;span class='p'&gt;:&lt;/span&gt; &lt;span class='n'&gt;ClassMapping&lt;/span&gt;&lt;span class='p'&gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;Student&lt;/span&gt;&lt;span class='p'&gt;&amp;gt;&lt;/span&gt;
&lt;span class='p'&gt;{&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='nf'&gt;StudentMapping&lt;/span&gt;&lt;span class='p'&gt;()&lt;/span&gt;
    &lt;span class='p'&gt;{&lt;/span&gt;
        &lt;span class='n'&gt;Table&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;Student&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
        &lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;student&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;student&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Generator&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;Generators&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Identity&lt;/span&gt;&lt;span class='p'&gt;));&lt;/span&gt;
        &lt;span class='n'&gt;Property&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;student&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;student&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Name&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
        &lt;span class='n'&gt;Bag&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;student&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;student&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Courses&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt;
            &lt;span class='p'&gt;{&lt;/span&gt;
                &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Table&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;Student_Course&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
                &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Key&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;keyMapper&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;keyMapper&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Column&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;StudentId&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;));&lt;/span&gt;
            &lt;span class='p'&gt;},&lt;/span&gt; &lt;span class='n'&gt;rel&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;rel&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;ManyToMany&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;m&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;m&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Column&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;CourseId&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;)));&lt;/span&gt;
    &lt;span class='p'&gt;}&lt;/span&gt;
&lt;span class='p'&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;</content>
 </entry>
 
 <entry>
   <title>nHibernate Mapping By Code - Introduction</title>
   <link href="http://zyzhang.github.com/blog/2012/07/01/nHibernateMappingByCode-Introduction"/>
   <updated>2012-07-01T00:00:00+08:00</updated>
   <id>http://zyzhang.github.com/blog/2012/07/01/nHibernateMappingByCode-Introduction</id>
   <content type="html">&lt;p&gt;nHibernate 3.2新增了一种mapping by code的映射策略，很有意思。你可以自定义约定，并且按照约定定制自动映射策略， 面对遗留数据库时这个功能往往很有用，另外，由于mapping by code是基于代码的（而不是xml文件）， 对domain object进行重命名的重构操作会非常方便，不用跑到xml映射文件查找字符串了。&lt;/p&gt;

&lt;p&gt;要使用Mapping by Code很简单，&lt;/p&gt;

&lt;h3 id='sessionfactorynhibernateclassmapping'&gt;第一步，配置SessionFactory，使nhibernate自动扫描项目中所有继承ClassMapping的类，并将其解释为映射&lt;/h3&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='csharp'&gt;&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;NHibernateHelper&lt;/span&gt;
&lt;span class='p'&gt;{&lt;/span&gt;
    &lt;span class='k'&gt;private&lt;/span&gt; &lt;span class='k'&gt;static&lt;/span&gt; &lt;span class='n'&gt;ISessionFactory&lt;/span&gt; &lt;span class='n'&gt;_sessionFactory&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt;

    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;static&lt;/span&gt; &lt;span class='n'&gt;ISessionFactory&lt;/span&gt; &lt;span class='n'&gt;SessionFactory&lt;/span&gt;
    &lt;span class='p'&gt;{&lt;/span&gt;
        &lt;span class='k'&gt;get&lt;/span&gt;
        &lt;span class='p'&gt;{&lt;/span&gt;
            &lt;span class='k'&gt;if&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;_sessionFactory&lt;/span&gt; &lt;span class='p'&gt;==&lt;/span&gt; &lt;span class='k'&gt;null&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
            &lt;span class='p'&gt;{&lt;/span&gt;
                &lt;span class='kt'&gt;var&lt;/span&gt; &lt;span class='n'&gt;configuration&lt;/span&gt; &lt;span class='p'&gt;=&lt;/span&gt; &lt;span class='k'&gt;new&lt;/span&gt; &lt;span class='n'&gt;Configuration&lt;/span&gt;&lt;span class='p'&gt;();&lt;/span&gt;
                &lt;span class='n'&gt;configuration&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Configure&lt;/span&gt;&lt;span class='p'&gt;();&lt;/span&gt;

                &lt;span class='kt'&gt;var&lt;/span&gt; &lt;span class='n'&gt;mappers&lt;/span&gt; &lt;span class='p'&gt;=&lt;/span&gt; &lt;span class='k'&gt;new&lt;/span&gt; &lt;span class='n'&gt;ModelMapper&lt;/span&gt;&lt;span class='p'&gt;();&lt;/span&gt;
                &lt;span class='n'&gt;mappers&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;AddMappings&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;Assembly&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;GetExecutingAssembly&lt;/span&gt;&lt;span class='p'&gt;().&lt;/span&gt;&lt;span class='n'&gt;GetExportedTypes&lt;/span&gt;&lt;span class='p'&gt;());&lt;/span&gt;

                &lt;span class='kt'&gt;var&lt;/span&gt; &lt;span class='n'&gt;hbmMapping&lt;/span&gt; &lt;span class='p'&gt;=&lt;/span&gt; &lt;span class='n'&gt;mappers&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;CompileMappingForAllExplicitlyAddedEntities&lt;/span&gt;&lt;span class='p'&gt;();&lt;/span&gt;
                &lt;span class='n'&gt;Console&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;WriteLine&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;hbmMapping&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;AsString&lt;/span&gt;&lt;span class='p'&gt;());&lt;/span&gt;

                &lt;span class='n'&gt;configuration&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;AddDeserializedMapping&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;hbmMapping&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s'&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;

                &lt;span class='n'&gt;_sessionFactory&lt;/span&gt; &lt;span class='p'&gt;=&lt;/span&gt; &lt;span class='n'&gt;configuration&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;BuildSessionFactory&lt;/span&gt;&lt;span class='p'&gt;();&lt;/span&gt;
            &lt;span class='p'&gt;}&lt;/span&gt;
            &lt;span class='k'&gt;return&lt;/span&gt; &lt;span class='n'&gt;_sessionFactory&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt;
        &lt;span class='p'&gt;}&lt;/span&gt;
    &lt;span class='p'&gt;}&lt;/span&gt;

    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;static&lt;/span&gt; &lt;span class='n'&gt;ISession&lt;/span&gt; &lt;span class='nf'&gt;OpenSession&lt;/span&gt;&lt;span class='p'&gt;()&lt;/span&gt;
    &lt;span class='p'&gt;{&lt;/span&gt;
        &lt;span class='k'&gt;return&lt;/span&gt; &lt;span class='n'&gt;SessionFactory&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;OpenSession&lt;/span&gt;&lt;span class='p'&gt;();&lt;/span&gt;
    &lt;span class='p'&gt;}&lt;/span&gt;
&lt;span class='p'&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt; &lt;/p&gt;

&lt;h3 id='classmappingnhibernate'&gt;第二步，为每个实体类编写映射类，映射类只需继承ClassMapping就可以被nhibernate识别。&lt;/h3&gt;

&lt;p&gt;关于如何编写映射类，参考以下文章：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href='/blog/2012/07/01/nHibernateMappingByCode-OneToOne'&gt;nHibernate Mapping By Code - One to One&lt;/a&gt;&lt;/li&gt;

&lt;li&gt;&lt;a href='/blog/2012/07/01/nHibernateMappingByCode-OneToManyandManyToOne'&gt;nHibernate Mapping By Code - One to Many and Many to One&lt;/a&gt;&lt;/li&gt;

&lt;li&gt;&lt;a href='/blog/2012/07/01/nHibernateMappingByCode-ManyToMany'&gt;nHibernate Mapping By Code - Many to Many&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id='id21'&gt;参考文章：&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href='http://nhforge.org/blogs/nhibernate/archive/2011/09/12/nh-mapping-by-code-vs-the-untouchable-db.aspx'&gt;NH Mapping by code VS the Untouchable DB&lt;/a&gt;&lt;/li&gt;

&lt;li&gt;&lt;a href='http://nhforge.org/blogs/nhibernate/archive/2011/09/05/using-nh3-2-mapping-by-code-for-automatic-mapping.aspx'&gt;Using NH3.2 mapping by code for Automatic Mapping&lt;/a&gt;&lt;/li&gt;

&lt;li&gt;&lt;a href='http://www.cnblogs.com/lyj/archive/2011/04/10/inside-nh-mapping-by-code-apply.html'&gt;NHibernate剖析：Mapping篇之Mapping-By-Code(2):运用ModelMapper&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content>
 </entry>
 
 <entry>
   <title>Hibernate N+1 问题</title>
   <link href="http://zyzhang.github.com/blog/2012/06/24/Hibernate-N-plus-one-problem"/>
   <updated>2012-06-24T00:00:00+08:00</updated>
   <id>http://zyzhang.github.com/blog/2012/06/24/Hibernate-N-plus-one-problem</id>
   <content type="html">&lt;p&gt;考虑下面的一对多关系：一个Department包含多个Employee：&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='csharp'&gt;&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;Employee&lt;/span&gt;
&lt;span class='p'&gt;{&lt;/span&gt;
	&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='kt'&gt;int&lt;/span&gt; &lt;span class='n'&gt;Id&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
	&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='kt'&gt;string&lt;/span&gt; &lt;span class='n'&gt;Name&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
	&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='kt'&gt;string&lt;/span&gt; &lt;span class='n'&gt;IdentityNumber&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
	&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='n'&gt;Department&lt;/span&gt; &lt;span class='n'&gt;Department&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
&lt;span class='p'&gt;}&lt;/span&gt;

&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;Department&lt;/span&gt;
&lt;span class='p'&gt;{&lt;/span&gt;
	&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='kt'&gt;int&lt;/span&gt; &lt;span class='n'&gt;Id&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
	&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='kt'&gt;string&lt;/span&gt; &lt;span class='n'&gt;Name&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;     
	&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;virtual&lt;/span&gt; &lt;span class='n'&gt;IList&lt;/span&gt;&lt;span class='p'&gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;Employee&lt;/span&gt;&lt;span class='p'&gt;&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;Employees&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='k'&gt;get&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;set&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='p'&gt;}&lt;/span&gt;
&lt;span class='p'&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;数据库中已有数据如下：&lt;/p&gt;

&lt;p&gt;&lt;img alt='nhibernate_n_1_db_data' src='/assets/image/posts/nhibernate_n_1_db_data.jpg' /&gt;&lt;/p&gt;

&lt;p&gt;默认情况下，Department.Employees是Lazy Load的，也就是说，当查询Department时，hibernate并不会将对应的employee也从数据库中加载进来， 而是在第一次调用Department.Employees时加载。&lt;/p&gt;

&lt;h3 id='n1'&gt;N+1问题是如何出现的&lt;/h3&gt;

&lt;p&gt;当应用程序需要遍历多个Department及其Employee时，问题就出现了，看测试代码：&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='csharp'&gt;&lt;span class='na'&gt;[Test]&lt;/span&gt;
&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;void&lt;/span&gt; &lt;span class='nf'&gt;show_n_plus_1_problem&lt;/span&gt;&lt;span class='p'&gt;()&lt;/span&gt;
&lt;span class='p'&gt;{&lt;/span&gt;
     &lt;span class='kt'&gt;var&lt;/span&gt; &lt;span class='n'&gt;modelMapper&lt;/span&gt; &lt;span class='p'&gt;=&lt;/span&gt; &lt;span class='k'&gt;new&lt;/span&gt; &lt;span class='n'&gt;ModelMapper&lt;/span&gt;&lt;span class='p'&gt;();&lt;/span&gt;
     &lt;span class='n'&gt;modelMapper&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Class&lt;/span&gt;&lt;span class='p'&gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;Department&lt;/span&gt;&lt;span class='p'&gt;&amp;gt;(&lt;/span&gt;&lt;span class='n'&gt;cm&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt;
     &lt;span class='p'&gt;{&lt;/span&gt;
          &lt;span class='n'&gt;cm&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Table&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;Department&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
          &lt;span class='n'&gt;cm&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Generator&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;Generators&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Identity&lt;/span&gt;&lt;span class='p'&gt;));&lt;/span&gt;
          &lt;span class='n'&gt;cm&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Property&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Name&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
          &lt;span class='n'&gt;cm&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Bag&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Employees&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Key&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;k&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;k&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Column&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;DepartmentId&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;)),&lt;/span&gt; &lt;span class='n'&gt;rel&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;rel&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;OneToMany&lt;/span&gt;&lt;span class='p'&gt;());&lt;/span&gt;
     &lt;span class='p'&gt;});&lt;/span&gt;
     &lt;span class='n'&gt;MapEmployee&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;modelMapper&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;

     &lt;span class='k'&gt;using&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='kt'&gt;var&lt;/span&gt; &lt;span class='n'&gt;sessionFactory&lt;/span&gt; &lt;span class='p'&gt;=&lt;/span&gt; &lt;span class='n'&gt;BuildSessionFactory&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;modelMapper&lt;/span&gt;&lt;span class='p'&gt;))&lt;/span&gt;
     &lt;span class='n'&gt;using&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='kt'&gt;var&lt;/span&gt; &lt;span class='n'&gt;session&lt;/span&gt; &lt;span class='p'&gt;=&lt;/span&gt; &lt;span class='n'&gt;sessionFactory&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;OpenSession&lt;/span&gt;&lt;span class='p'&gt;())&lt;/span&gt;
     &lt;span class='p'&gt;{&lt;/span&gt;
          &lt;span class='c1'&gt;// 1 query for retrieve all departments, got n departments&lt;/span&gt;
          &lt;span class='c1'&gt;// n query to retrieve all employees&lt;/span&gt;
          &lt;span class='kt'&gt;var&lt;/span&gt; &lt;span class='n'&gt;departments&lt;/span&gt; &lt;span class='p'&gt;=&lt;/span&gt; &lt;span class='n'&gt;session&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;QueryOver&lt;/span&gt;&lt;span class='p'&gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;Department&lt;/span&gt;&lt;span class='p'&gt;&amp;gt;().&lt;/span&gt;&lt;span class='n'&gt;List&lt;/span&gt;&lt;span class='p'&gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;Department&lt;/span&gt;&lt;span class='p'&gt;&amp;gt;();&lt;/span&gt;
          &lt;span class='n'&gt;Assert&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;AreEqual&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='m'&gt;3&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;departments&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Count&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
          &lt;span class='n'&gt;departments&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;ForEach&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;department&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;department&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Employees&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;ForEach&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;employee&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;Console&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;WriteLine&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;employee&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Name&lt;/span&gt;&lt;span class='p'&gt;)));&lt;/span&gt;
     &lt;span class='p'&gt;}&lt;/span&gt;
&lt;span class='p'&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;  为了能在测试中动态改变nhibernate映射，这里使用了nHibernate 3.2新增的map by code特性。&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='csharp'&gt;&lt;span class='k'&gt;private&lt;/span&gt; &lt;span class='k'&gt;void&lt;/span&gt; &lt;span class='nf'&gt;MapEmployee&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;ModelMapper&lt;/span&gt; &lt;span class='n'&gt;modelMapper&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;span class='p'&gt;{&lt;/span&gt;
     &lt;span class='n'&gt;modelMapper&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Class&lt;/span&gt;&lt;span class='p'&gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;Employee&lt;/span&gt;&lt;span class='p'&gt;&amp;gt;(&lt;/span&gt;&lt;span class='n'&gt;cm&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt;
         &lt;span class='p'&gt;{&lt;/span&gt;
          　　 &lt;span class='n'&gt;cm&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Table&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;Employee&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
              &lt;span class='n'&gt;cm&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Generator&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;Generators&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Identity&lt;/span&gt;&lt;span class='p'&gt;));&lt;/span&gt;
          　　 &lt;span class='n'&gt;cm&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Property&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Name&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
          　　 &lt;span class='n'&gt;cm&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Property&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;IdentityNumber&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
              &lt;span class='n'&gt;cm&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;ManyToOne&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Department&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Column&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;DepartmentId&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;));&lt;/span&gt;
　　　　　&lt;span class='p'&gt;});&lt;/span&gt;
&lt;span class='p'&gt;}&lt;/span&gt;

&lt;span class='k'&gt;private&lt;/span&gt; &lt;span class='n'&gt;ISessionFactory&lt;/span&gt; &lt;span class='nf'&gt;BuildSessionFactory&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;ModelMapper&lt;/span&gt; &lt;span class='n'&gt;modelMapper&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;span class='p'&gt;{&lt;/span&gt;
     &lt;span class='kt'&gt;var&lt;/span&gt; &lt;span class='n'&gt;configuration&lt;/span&gt; &lt;span class='p'&gt;=&lt;/span&gt; &lt;span class='k'&gt;new&lt;/span&gt; &lt;span class='n'&gt;Configuration&lt;/span&gt;&lt;span class='p'&gt;();&lt;/span&gt;
     &lt;span class='n'&gt;configuration&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Configure&lt;/span&gt;&lt;span class='p'&gt;();&lt;/span&gt;

     &lt;span class='n'&gt;HbmMapping&lt;/span&gt; &lt;span class='n'&gt;hbmMapping&lt;/span&gt; &lt;span class='p'&gt;=&lt;/span&gt; &lt;span class='n'&gt;modelMapper&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;CompileMappingForAllExplicitlyAddedEntities&lt;/span&gt;&lt;span class='p'&gt;();&lt;/span&gt;
     &lt;span class='n'&gt;Console&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;WriteLine&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;hbmMapping&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;AsString&lt;/span&gt;&lt;span class='p'&gt;());&lt;/span&gt;

     &lt;span class='n'&gt;configuration&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;AddDeserializedMapping&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;hbmMapping&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s'&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;

     &lt;span class='k'&gt;return&lt;/span&gt; &lt;span class='n'&gt;configuration&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;BuildSessionFactory&lt;/span&gt;&lt;span class='p'&gt;();&lt;/span&gt;
&lt;span class='p'&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;运行测试可以发现，hibernate实际执行了如下sql查询：&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='sql'&gt;&lt;span class='k'&gt;SELECT&lt;/span&gt; &lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;Name&lt;/span&gt; &lt;span class='k'&gt;FROM&lt;/span&gt; &lt;span class='n'&gt;Department&lt;/span&gt;
&lt;span class='k'&gt;SELECT&lt;/span&gt; &lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;Name&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;IdentityNumber&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;DepartmentId&lt;/span&gt; &lt;span class='k'&gt;FROM&lt;/span&gt; &lt;span class='n'&gt;Employee&lt;/span&gt; &lt;span class='k'&gt;WHERE&lt;/span&gt; &lt;span class='n'&gt;DepartmentId&lt;/span&gt;&lt;span class='o'&gt;=&lt;/span&gt;&lt;span class='mi'&gt;1&lt;/span&gt;
&lt;span class='k'&gt;SELECT&lt;/span&gt; &lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;Name&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;IdentityNumber&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;DepartmentId&lt;/span&gt; &lt;span class='k'&gt;FROM&lt;/span&gt; &lt;span class='n'&gt;Employee&lt;/span&gt; &lt;span class='k'&gt;WHERE&lt;/span&gt; &lt;span class='n'&gt;DepartmentId&lt;/span&gt;&lt;span class='o'&gt;=&lt;/span&gt;&lt;span class='mi'&gt;2&lt;/span&gt;
&lt;span class='k'&gt;SELECT&lt;/span&gt; &lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;Name&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;IdentityNumber&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;DepartmentId&lt;/span&gt; &lt;span class='k'&gt;FROM&lt;/span&gt; &lt;span class='n'&gt;Employee&lt;/span&gt; &lt;span class='k'&gt;WHERE&lt;/span&gt; &lt;span class='n'&gt;DepartmentId&lt;/span&gt;&lt;span class='o'&gt;=&lt;/span&gt;&lt;span class='mi'&gt;3&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;当执行&lt;code&gt;session.QueryOver&amp;lt;Department&amp;gt;().List&amp;lt;Department&amp;gt;()&lt;/code&gt;时， nhibernate执行了1次查询&lt;code&gt;SELECT Id, Name FROM Department&lt;/code&gt;， 此时&lt;em&gt;department.Employees&lt;/em&gt;中并没有加载出对应的 &lt;em&gt;Employee&lt;/em&gt;，而每次调用&lt;em&gt;department.Employees&lt;/em&gt;时，nhibernate都会从&lt;em&gt;Employee&lt;/em&gt;表中加载相应的Employee。&lt;/p&gt;

&lt;p&gt;因此，对N个&lt;em&gt;Department&lt;/em&gt;，实际会执行&lt;em&gt;N+1&lt;/em&gt;次查询。这将对性能造成很大影响。&lt;/p&gt;

&lt;h3 id='n1'&gt;如何解决N+1问题&lt;/h3&gt;

&lt;h4 id='1batch_load'&gt;（1）采用Batch Load批量加载&lt;/h4&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='csharp'&gt;&lt;span class='na'&gt;[Test]&lt;/span&gt;
&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;void&lt;/span&gt; &lt;span class='nf'&gt;resolve_n_plus_1_problem_by_batch_load&lt;/span&gt;&lt;span class='p'&gt;()&lt;/span&gt;
&lt;span class='p'&gt;{&lt;/span&gt;
     &lt;span class='kt'&gt;var&lt;/span&gt; &lt;span class='n'&gt;modelMapper&lt;/span&gt; &lt;span class='p'&gt;=&lt;/span&gt; &lt;span class='k'&gt;new&lt;/span&gt; &lt;span class='n'&gt;ModelMapper&lt;/span&gt;&lt;span class='p'&gt;();&lt;/span&gt;
     &lt;span class='n'&gt;modelMapper&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Class&lt;/span&gt;&lt;span class='p'&gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;Department&lt;/span&gt;&lt;span class='p'&gt;&amp;gt;(&lt;/span&gt;&lt;span class='n'&gt;cm&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt;
     &lt;span class='p'&gt;{&lt;/span&gt;
          &lt;span class='n'&gt;cm&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Table&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;Department&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
          &lt;span class='n'&gt;cm&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Generator&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;Generators&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Identity&lt;/span&gt;&lt;span class='p'&gt;));&lt;/span&gt;
          &lt;span class='n'&gt;cm&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Property&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Name&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
          &lt;span class='n'&gt;cm&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Bag&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Employees&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt;
          &lt;span class='p'&gt;{&lt;/span&gt;
               &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Key&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;k&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;k&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Column&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;DepartmentId&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;));&lt;/span&gt;
               &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;BatchSize&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='m'&gt;2&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt; &lt;span class='c1'&gt;// add batch size to batch load employees&lt;/span&gt;
          &lt;span class='p'&gt;},&lt;/span&gt; &lt;span class='n'&gt;rel&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;rel&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;OneToMany&lt;/span&gt;&lt;span class='p'&gt;());&lt;/span&gt;
     &lt;span class='p'&gt;});&lt;/span&gt;
     &lt;span class='n'&gt;MapEmployee&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;modelMapper&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;

     &lt;span class='k'&gt;using&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='kt'&gt;var&lt;/span&gt; &lt;span class='n'&gt;sessionFactory&lt;/span&gt; &lt;span class='p'&gt;=&lt;/span&gt; &lt;span class='n'&gt;BuildSessionFactory&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;modelMapper&lt;/span&gt;&lt;span class='p'&gt;))&lt;/span&gt;
     &lt;span class='k'&gt;using&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='kt'&gt;var&lt;/span&gt; &lt;span class='n'&gt;session&lt;/span&gt; &lt;span class='p'&gt;=&lt;/span&gt; &lt;span class='n'&gt;sessionFactory&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;OpenSession&lt;/span&gt;&lt;span class='p'&gt;())&lt;/span&gt;
     &lt;span class='p'&gt;{&lt;/span&gt;
          &lt;span class='c1'&gt;// 1 query for retrieve all departments, got n departments&lt;/span&gt;
          &lt;span class='c1'&gt;// ceil(n/BatchSize) query to retrieve all employees&lt;/span&gt;
          &lt;span class='kt'&gt;var&lt;/span&gt; &lt;span class='n'&gt;departments&lt;/span&gt; &lt;span class='p'&gt;=&lt;/span&gt; &lt;span class='n'&gt;session&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;QueryOver&lt;/span&gt;&lt;span class='p'&gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;Department&lt;/span&gt;&lt;span class='p'&gt;&amp;gt;().&lt;/span&gt;&lt;span class='n'&gt;List&lt;/span&gt;&lt;span class='p'&gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;Department&lt;/span&gt;&lt;span class='p'&gt;&amp;gt;();&lt;/span&gt;
          &lt;span class='n'&gt;Assert&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;AreEqual&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='m'&gt;3&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;departments&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Count&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
          &lt;span class='n'&gt;departments&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;ForEach&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;department&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;department&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Employees&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;ForEach&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;employee&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;Console&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;WriteLine&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;employee&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Name&lt;/span&gt;&lt;span class='p'&gt;)));&lt;/span&gt;
     &lt;span class='p'&gt;}&lt;/span&gt;
&lt;span class='p'&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;nHibernate实际执行查询：&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='sql'&gt;&lt;span class='k'&gt;SELECT&lt;/span&gt; &lt;span class='n'&gt;this_&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt; &lt;span class='k'&gt;as&lt;/span&gt; &lt;span class='n'&gt;Id0_0_&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;this_&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Name&lt;/span&gt; &lt;span class='k'&gt;as&lt;/span&gt; &lt;span class='n'&gt;Name0_0_&lt;/span&gt; &lt;span class='k'&gt;FROM&lt;/span&gt; &lt;span class='n'&gt;Department&lt;/span&gt; &lt;span class='n'&gt;this_&lt;/span&gt;
&lt;span class='k'&gt;SELECT&lt;/span&gt; &lt;span class='p'&gt;...&lt;/span&gt; &lt;span class='k'&gt;FROM&lt;/span&gt; &lt;span class='n'&gt;Employee&lt;/span&gt; &lt;span class='n'&gt;employees0_&lt;/span&gt; &lt;span class='k'&gt;WHERE&lt;/span&gt; &lt;span class='n'&gt;employees0_&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;DepartmentId&lt;/span&gt; &lt;span class='k'&gt;in&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='mi'&gt;1&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='mi'&gt;2&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
&lt;span class='k'&gt;SELECT&lt;/span&gt; &lt;span class='p'&gt;...&lt;/span&gt; &lt;span class='k'&gt;FROM&lt;/span&gt; &lt;span class='n'&gt;Employee&lt;/span&gt; &lt;span class='n'&gt;employees0_&lt;/span&gt; &lt;span class='k'&gt;WHERE&lt;/span&gt; &lt;span class='n'&gt;employees0_&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;DepartmentId&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='mi'&gt;3&lt;/span&gt; 
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;  这种方式并没有完全解决N+1查询问题，但显著减少了查询次数，实际查询为&lt;code&gt;ceil(n/BatchSize) + 1&lt;/code&gt;次，BatchSize足够大时，查询次数为2次。&lt;/p&gt;

&lt;h4 id='2join_fetch'&gt;（2）使用Join Fetch一次性加载所有数据&lt;/h4&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='csharp'&gt;&lt;span class='na'&gt;[Test]&lt;/span&gt;
&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;void&lt;/span&gt; &lt;span class='nf'&gt;resolve_n_plus_1_problem_by_join_fetch&lt;/span&gt;&lt;span class='p'&gt;()&lt;/span&gt;
&lt;span class='p'&gt;{&lt;/span&gt;
     &lt;span class='kt'&gt;var&lt;/span&gt; &lt;span class='n'&gt;modelMapper&lt;/span&gt; &lt;span class='p'&gt;=&lt;/span&gt; &lt;span class='k'&gt;new&lt;/span&gt; &lt;span class='n'&gt;ModelMapper&lt;/span&gt;&lt;span class='p'&gt;();&lt;/span&gt;
     &lt;span class='n'&gt;modelMapper&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Class&lt;/span&gt;&lt;span class='p'&gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;Department&lt;/span&gt;&lt;span class='p'&gt;&amp;gt;(&lt;/span&gt;&lt;span class='n'&gt;cm&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt;
     &lt;span class='p'&gt;{&lt;/span&gt;
          &lt;span class='n'&gt;cm&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Table&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;Department&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
          &lt;span class='n'&gt;cm&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Generator&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;Generators&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Identity&lt;/span&gt;&lt;span class='p'&gt;));&lt;/span&gt;
          &lt;span class='n'&gt;cm&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Property&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Name&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
          &lt;span class='n'&gt;cm&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Bag&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Employees&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt;
          &lt;span class='p'&gt;{&lt;/span&gt;
               &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Key&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;k&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;k&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Column&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;DepartmentId&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;));&lt;/span&gt;
               &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Fetch&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;CollectionFetchMode&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Join&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt; &lt;span class='c1'&gt;// eager load employees&lt;/span&gt;
          &lt;span class='p'&gt;},&lt;/span&gt; &lt;span class='n'&gt;rel&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;rel&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;OneToMany&lt;/span&gt;&lt;span class='p'&gt;());&lt;/span&gt;
     &lt;span class='p'&gt;});&lt;/span&gt;
     &lt;span class='n'&gt;MapEmployee&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;modelMapper&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;

     &lt;span class='k'&gt;using&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='kt'&gt;var&lt;/span&gt; &lt;span class='n'&gt;sessionFactory&lt;/span&gt; &lt;span class='p'&gt;=&lt;/span&gt; &lt;span class='n'&gt;BuildSessionFactory&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;modelMapper&lt;/span&gt;&lt;span class='p'&gt;))&lt;/span&gt;
     &lt;span class='k'&gt;using&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='kt'&gt;var&lt;/span&gt; &lt;span class='n'&gt;session&lt;/span&gt; &lt;span class='p'&gt;=&lt;/span&gt; &lt;span class='n'&gt;sessionFactory&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;OpenSession&lt;/span&gt;&lt;span class='p'&gt;())&lt;/span&gt;
     &lt;span class='p'&gt;{&lt;/span&gt;
          &lt;span class='c1'&gt;// 1 query for retrieve all departments and employees&lt;/span&gt;
          &lt;span class='kt'&gt;var&lt;/span&gt; &lt;span class='n'&gt;departments&lt;/span&gt; &lt;span class='p'&gt;=&lt;/span&gt; &lt;span class='k'&gt;new&lt;/span&gt; &lt;span class='n'&gt;HashSet&lt;/span&gt;&lt;span class='p'&gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;Department&lt;/span&gt;&lt;span class='p'&gt;&amp;gt;(&lt;/span&gt;&lt;span class='n'&gt;session&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;QueryOver&lt;/span&gt;&lt;span class='p'&gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;Department&lt;/span&gt;&lt;span class='p'&gt;&amp;gt;().&lt;/span&gt;&lt;span class='n'&gt;List&lt;/span&gt;&lt;span class='p'&gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;Department&lt;/span&gt;&lt;span class='p'&gt;&amp;gt;()).&lt;/span&gt;&lt;span class='n'&gt;ToList&lt;/span&gt;&lt;span class='p'&gt;();&lt;/span&gt;
          &lt;span class='n'&gt;Assert&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;AreEqual&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='m'&gt;3&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;departments&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Count&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
          &lt;span class='n'&gt;departments&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;ForEach&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;department&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;department&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Employees&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;ForEach&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;employee&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;Console&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;WriteLine&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;employee&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Name&lt;/span&gt;&lt;span class='p'&gt;)));&lt;/span&gt;
     &lt;span class='p'&gt;}&lt;/span&gt;
&lt;span class='p'&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;  nHibernate实际执行查询：&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='sql'&gt;&lt;span class='k'&gt;SELECT&lt;/span&gt; &lt;span class='p'&gt;...&lt;/span&gt; &lt;span class='k'&gt;FROM&lt;/span&gt; &lt;span class='n'&gt;Department&lt;/span&gt; &lt;span class='n'&gt;this_&lt;/span&gt; &lt;span class='k'&gt;left&lt;/span&gt; &lt;span class='k'&gt;outer&lt;/span&gt; &lt;span class='k'&gt;join&lt;/span&gt; &lt;span class='n'&gt;Employee&lt;/span&gt; &lt;span class='n'&gt;employees2_&lt;/span&gt; &lt;span class='k'&gt;on&lt;/span&gt; &lt;span class='n'&gt;this_&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='o'&gt;=&lt;/span&gt;&lt;span class='n'&gt;employees2_&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;DepartmentId&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;  需要注意的是，这种join fetch会导致重复记录，比如本例中，因为Jim和Rechard同属于Finance部门，所以departments实际查询出4条记录， 还需用Set过一遍以保证departments集合元素的唯一性。&lt;/p&gt;

&lt;p&gt;另外，这种在映射中直接配置join fetch的做法也不够灵活，在某些场景中，可能并不关心&lt;em&gt;Department.Employees&lt;/em&gt;，join fetch没有必要。&lt;/p&gt;

&lt;h4 id='3departmentemployeeslazyjoin_fetch'&gt;（3）&lt;em&gt;Department.Employees&lt;/em&gt;映射仍然是Lazy的，仅在需要时通过join fetch加载&lt;/h4&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='csharp'&gt;&lt;span class='na'&gt;[Test]&lt;/span&gt;
&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;void&lt;/span&gt; &lt;span class='nf'&gt;resolve_n_plus_1_problem_by_join_fetch_when_necessary&lt;/span&gt;&lt;span class='p'&gt;()&lt;/span&gt;
&lt;span class='p'&gt;{&lt;/span&gt;
     &lt;span class='kt'&gt;var&lt;/span&gt; &lt;span class='n'&gt;modelMapper&lt;/span&gt; &lt;span class='p'&gt;=&lt;/span&gt; &lt;span class='k'&gt;new&lt;/span&gt; &lt;span class='n'&gt;ModelMapper&lt;/span&gt;&lt;span class='p'&gt;();&lt;/span&gt;
     &lt;span class='n'&gt;modelMapper&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Class&lt;/span&gt;&lt;span class='p'&gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;Department&lt;/span&gt;&lt;span class='p'&gt;&amp;gt;(&lt;/span&gt;&lt;span class='n'&gt;cm&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt;
     &lt;span class='p'&gt;{&lt;/span&gt;
          &lt;span class='n'&gt;cm&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Table&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;Department&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
          &lt;span class='n'&gt;cm&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Generator&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;Generators&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Identity&lt;/span&gt;&lt;span class='p'&gt;));&lt;/span&gt;
          &lt;span class='n'&gt;cm&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Property&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Name&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
          &lt;span class='n'&gt;cm&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Bag&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Employees&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;map&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Key&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;k&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;k&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Column&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;DepartmentId&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;)),&lt;/span&gt; &lt;span class='n'&gt;rel&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;rel&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;OneToMany&lt;/span&gt;&lt;span class='p'&gt;());&lt;/span&gt;
     &lt;span class='p'&gt;});&lt;/span&gt;
     &lt;span class='n'&gt;MapEmployee&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;modelMapper&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;

     &lt;span class='k'&gt;using&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='kt'&gt;var&lt;/span&gt; &lt;span class='n'&gt;sessionFactory&lt;/span&gt; &lt;span class='p'&gt;=&lt;/span&gt; &lt;span class='n'&gt;BuildSessionFactory&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;modelMapper&lt;/span&gt;&lt;span class='p'&gt;))&lt;/span&gt;
     &lt;span class='k'&gt;using&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='kt'&gt;var&lt;/span&gt; &lt;span class='n'&gt;session&lt;/span&gt; &lt;span class='p'&gt;=&lt;/span&gt; &lt;span class='n'&gt;sessionFactory&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;OpenSession&lt;/span&gt;&lt;span class='p'&gt;())&lt;/span&gt;
     &lt;span class='p'&gt;{&lt;/span&gt;
          &lt;span class='c1'&gt;// 1 query for retrieve all departments and all employees&lt;/span&gt;
          &lt;span class='c1'&gt;// Note: the retrieved departments will be duplicated if excluding the &amp;#39;distinct&amp;#39; keyword&lt;/span&gt;
          &lt;span class='kt'&gt;var&lt;/span&gt; &lt;span class='n'&gt;departments&lt;/span&gt; &lt;span class='p'&gt;=&lt;/span&gt; &lt;span class='n'&gt;session&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;CreateQuery&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;select distinct d from Department d left join fetch d.Employees&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;).&lt;/span&gt;&lt;span class='n'&gt;List&lt;/span&gt;&lt;span class='p'&gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;Department&lt;/span&gt;&lt;span class='p'&gt;&amp;gt;();&lt;/span&gt;
          &lt;span class='n'&gt;Assert&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;AreEqual&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='m'&gt;3&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;departments&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Count&lt;/span&gt;&lt;span class='p'&gt;);&lt;/span&gt;
          &lt;span class='n'&gt;departments&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;ForEach&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;department&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;department&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Employees&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;ForEach&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;employee&lt;/span&gt; &lt;span class='p'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;Console&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;WriteLine&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;employee&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Name&lt;/span&gt;&lt;span class='p'&gt;)));&lt;/span&gt;
     &lt;span class='p'&gt;}&lt;/span&gt;
&lt;span class='p'&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;nHibernate实际执行查询：&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='sql'&gt;&lt;span class='k'&gt;select&lt;/span&gt; &lt;span class='k'&gt;distinct&lt;/span&gt; &lt;span class='n'&gt;d&lt;/span&gt;&lt;span class='p'&gt;...&lt;/span&gt; &lt;span class='k'&gt;from&lt;/span&gt; &lt;span class='n'&gt;Department&lt;/span&gt; &lt;span class='n'&gt;department0_&lt;/span&gt; &lt;span class='k'&gt;left&lt;/span&gt; &lt;span class='k'&gt;outer&lt;/span&gt; &lt;span class='k'&gt;join&lt;/span&gt; &lt;span class='n'&gt;Employee&lt;/span&gt; &lt;span class='n'&gt;employees1_&lt;/span&gt; &lt;span class='k'&gt;on&lt;/span&gt; &lt;span class='n'&gt;department0_&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;Id&lt;/span&gt;&lt;span class='o'&gt;=&lt;/span&gt;&lt;span class='n'&gt;employees1_&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;DepartmentId&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;  实际应用中，往往有些场景只关心department的数据，而不关心&lt;code&gt;department.Employees&lt;/code&gt;; 而有些场景恰恰相反，关心&lt;code&gt;department.Employees&lt;/code&gt;。 上面的例子就很有价值了，默认&lt;code&gt;department.Employees&lt;/code&gt;为lazy load，在需要遍历&lt;code&gt;department.Employee&lt;/code&gt;的场景使用另外的方法加载department， 例如：&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='csharp'&gt;&lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nc'&gt;DepartmentRepository&lt;/span&gt; 
&lt;span class='p'&gt;{&lt;/span&gt;
    &lt;span class='p'&gt;....&lt;/span&gt;
    &lt;span class='k'&gt;public&lt;/span&gt; &lt;span class='n'&gt;IList&lt;/span&gt;&lt;span class='p'&gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;Department&lt;/span&gt;&lt;span class='p'&gt;&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;FindAll&lt;/span&gt;&lt;span class='p'&gt;()&lt;/span&gt;
    &lt;span class='p'&gt;{&lt;/span&gt;
        &lt;span class='k'&gt;return&lt;/span&gt; &lt;span class='n'&gt;session&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;CreateQuery&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;select distinct d from Department d left join fetch d.Employees&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;).&lt;/span&gt;&lt;span class='n'&gt;List&lt;/span&gt;&lt;span class='p'&gt;&amp;lt;&lt;/span&gt;&lt;span class='n'&gt;Department&lt;/span&gt;&lt;span class='p'&gt;&amp;gt;();&lt;/span&gt;
    &lt;span class='p'&gt;}&lt;/span&gt;
&lt;span class='p'&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;</content>
 </entry>
 
 <entry>
   <title>莫让代码腐化：让营地比你来时更干净</title>
   <link href="http://zyzhang.github.com/blog/2011/11/13/%E8%8E%AB%E8%AE%A9%E4%BB%A3%E7%A0%81%E8%85%90%E5%8C%96%EF%BC%9A%E8%AE%A9%E8%90%A5%E5%9C%B0%E6%AF%94%E4%BD%A0%E6%9D%A5%E6%97%B6%E6%9B%B4%E5%B9%B2%E5%87%80"/>
   <updated>2011-11-13T00:00:00+08:00</updated>
   <id>http://zyzhang.github.com/blog/2011/11/13/莫让代码腐化：让营地比你来时更干净</id>
   <content type="html">&lt;p&gt;你是否遇到过这样的场景呢？Code Review时：&lt;/p&gt;

&lt;p&gt;A：我在XXX类加了一个新方法来实现&amp;#8230;..&lt;/p&gt;

&lt;p&gt;B：等等，我觉得这个地方应该改一改，blablabla&amp;#8230;.&lt;/p&gt;

&lt;p&gt;A：呃，那是以前的代码，所以我没动，我只是在这个类里加了个新方法&amp;#8230;.&lt;/p&gt;

&lt;p&gt;重读Clean Code，忽然对Bob大叔提到的童子军军规深有感触：“让营地比你来时更干净”。&lt;/p&gt;

&lt;p&gt;代码总是随着时间的流逝，需求的增加而逐渐腐化（还有架构）！我们不希望我们的代码最终成为别人眼中的Legacy Code，正如我们自己接手如同烂泥一样的code base时心头暗骂一样。&lt;/p&gt;

&lt;p&gt;一直保持整洁的代码，我们真的做不到么？进度压力，需求膨胀，经验少的队友，这些真的是原因么？&lt;/p&gt;

&lt;p&gt;其实，我们只需做很简单的一件事：让营地比你来时更干净！代码每次check in时都比check out时更干净，每个类甚至每个方法都比你留下痕迹之前更干净，哪怕只是重命名一个变量， 消除了一点点重复代码，拆分了一个有点长的函数&amp;#8230;.&lt;/p&gt;

&lt;p&gt;让营地比你来时更干净，营地会越来越干净！&lt;/p&gt;</content>
 </entry>
 
 
</feed>